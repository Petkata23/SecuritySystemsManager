@{
    ViewData["Title"] = "Dropbox Authentication Complete";
}

<div class="container mt-4">
    <h2>Dropbox Authentication Complete</h2>
    <div class="alert alert-success">
        <p>Authentication successful! Your tokens have been generated and saved to the configuration file.</p>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h4>Refresh Token</h4>
        </div>
        <div class="card-body">
            <p>Your refresh token has been saved to the configuration file:</p>
            <div class="input-group">
                <input type="text" id="refreshToken" class="form-control" value="@ViewBag.RefreshToken" readonly>
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('refreshToken')">Copy</button>
                </div>
            </div>
            <small class="form-text text-muted">This refresh token does not expire and can be used to generate new access tokens.</small>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h4>Access Token</h4>
        </div>
        <div class="card-body">
            <p>Current access token:</p>
            <div class="input-group">
                <input type="text" id="accessToken" class="form-control" value="@ViewBag.AccessToken" readonly>
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('accessToken')">Copy</button>
                </div>
            </div>
            <div class="mt-3">
                <strong>Expires in:</strong> @ViewBag.ExpiresIn seconds
            </div>
            <div>
                <strong>Expiry time:</strong> @(ViewBag.ExpiryTime != null ? ((DateTime)ViewBag.ExpiryTime).ToString("yyyy-MM-dd HH:mm:ss") + " UTC" : "Unknown")
            </div>
            <small class="form-text text-muted mt-2">This access token will expire. The system will automatically refresh it when needed.</small>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h4>Test Token Refresh</h4>
        </div>
        <div class="card-body">
            <p>You can test the token refresh functionality using the button below:</p>
            <button id="testRefreshBtn" class="btn btn-primary">Test Token Refresh</button>
            <div id="refreshResult" class="mt-3"></div>
        </div>
    </div>
    
    <div class="alert alert-info mt-4">
        <h5>All Done!</h5>
        <p>Your Dropbox integration is now set up. The system will automatically refresh the access token when needed.</p>
    </div>
</div>

@section Scripts {
    <script>
        function copyToClipboard(elementId) {
            var copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("Copied to clipboard!");
        }
        
        $(document).ready(function() {
            $('#testRefreshBtn').click(function() {
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...');
                $('#refreshResult').html('');
                
                $.ajax({
                    url: '@Url.Action("TestTokenRefresh", "DropboxAuth")',
                    type: 'GET',
                    success: function(response) {
                        if (response.success) {
                            $('#refreshResult').html('<div class="alert alert-success">' + 
                                '<strong>Success!</strong> ' + response.message + '<br>' +
                                'Token: ' + response.tokenFirstChars + '</div>');
                        } else {
                            $('#refreshResult').html('<div class="alert alert-danger">' + 
                                '<strong>Error!</strong> ' + response.message + '</div>');
                        }
                    },
                    error: function() {
                        $('#refreshResult').html('<div class="alert alert-danger">' + 
                            '<strong>Error!</strong> Failed to test token refresh.</div>');
                    },
                    complete: function() {
                        $('#testRefreshBtn').prop('disabled', false).html('Test Token Refresh');
                    }
                });
            });
        });
    </script>
} 