@model SecuritySystemsManagerMVC.ViewModels.SecuritySystemOrderDetailsVm
@using SecuritySystemsManager.Shared.Enums

@{
    ViewData["Title"] = "Order Details";
    bool isClient = User.IsInRole("Client");
    bool isAdminOrManager = User.IsInRole("Admin") || User.IsInRole("Manager");
    bool isTechnician = User.IsInRole("Technician");
    bool canManageMaintenance = User.IsInRole("Admin") || User.IsInRole("Manager");
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="~/css/orders.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/order-details.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom-modal.css" asp-append-version="true" />
}

<div class="container-fluid animate-fade-in px-5">
    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    <div class="row mb-5">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">@Model.Title</h1>
                            <p class="mb-0">Order #@Model.Id</p>
                        </div>
                        <div>
                            <span class="badge bg-@GetStatusBadgeClass(Model.Status) fs-6 p-2">
                                @GetStatusDisplayName(Model.Status)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 px-3">
            <!-- Order Information - Professional Layout -->
            <div class="order-information-container">
                <!-- Order Overview Section -->
                <div class="card shadow-sm mb-4 order-overview-card">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">
                                    <i class="bi bi-file-earmark-text me-2"></i>Order Overview
                                </h5>
                                <small>Complete order details and specifications</small>
                            </div>
                            <div class="order-status-badge">
                                <span class="badge bg-@GetStatusBadgeClass(Model.Status) fs-6 px-3 py-2">
                                    <i class="bi bi-@(Model.Status == OrderStatus.Pending ? "clock" : Model.Status == OrderStatus.InProgress ? "gear" : Model.Status == OrderStatus.Completed ? "check-circle" : "x-circle") me-1"></i>
                                    @GetStatusDisplayName(Model.Status)
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row g-0">
                            <!-- Order Details -->
                            <div class="col-lg-8 p-5">
                                <div class="order-details-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-info-circle me-2"></i>Order Details
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <label class="info-label">Title</label>
                                                <div class="info-value">@Model.Title</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <label class="info-label">Phone Number</label>
                                                <div class="info-value">
                                                    <i class="bi bi-telephone me-1"></i>@Model.PhoneNumber
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="info-item">
                                                <label class="info-label">Description</label>
                                                <div class="info-value description-text">@Model.Description</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <label class="info-label">Requested Date</label>
                                                <div class="info-value">
                                                    <i class="bi bi-calendar-event me-1"></i>@Model.RequestedDate.ToString("dd/MM/yyyy HH:mm")
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-item">
                                                <label class="info-label">Order ID</label>
                                                <div class="info-value">
                                                    <span class="badge bg-secondary">#@Model.Id</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Client Information -->
                            <div class="col-lg-4 p-5 client-section">
                                <div class="client-info-card">
                                    <h6 class="section-title">
                                        <i class="bi bi-person-circle me-2"></i>Client Information
                                    </h6>
                                    @if (Model.Client != null)
                                    {
                                        <div class="client-profile">
                                            <div class="client-avatar-large">
                                                @if (!string.IsNullOrEmpty(Model.Client.ProfileImage))
                                                {
                                                    <img src="@Model.Client.ProfileImage" alt="@Model.Client.FirstName @Model.Client.LastName" class="rounded-circle">
                                                }
                                                else
                                                {
                                                    <div class="client-initials-large">
                                                        @(Model.Client.FirstName?.Substring(0, 1))@(Model.Client.LastName?.Substring(0, 1))
                                                    </div>
                                                }
                                            </div>
                                            <div class="client-details">
                                                <h6 class="client-name">@Model.Client.FirstName @Model.Client.LastName</h6>
                                                <p class="client-email">
                                                    <i class="bi bi-envelope me-1"></i>@Model.Client.Email
                                                </p>
                                                <div class="client-meta">
                                                    <span class="client-username">
                                                        <i class="bi bi-person me-1"></i>@Model.Client.Username
                                                    </span>
                                                    <span class="client-role">
                                                        <i class="bi bi-shield me-1"></i>@Model.Client.RoleName
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="no-client-info">
                                            <i class="bi bi-person-x text-muted"></i>
                                            <p class="text-muted mb-0">No client information available</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Information Section -->
                @if (Model.Location != null)
                {
                    <div class="card shadow-sm mb-4 location-card">
                        <div class="card-header bg-gradient-info text-white">
                            <h5 class="mb-1">
                                <i class="bi bi-geo-alt me-2"></i>Installation Location
                            </h5>
                            <small>Site details and geographic information</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="row g-0">
                                <!-- Location Details -->
                                <div class="col-lg-6 p-5">
                                    <div class="location-details-section">
                                        <div class="location-header mb-4">
                                            <h6 class="location-name">
                                                <i class="bi bi-building me-2"></i>@Model.Location.Name
                                            </h6>
                                            <p class="location-description text-muted">@Model.Location.Description</p>
                                        </div>
                                        
                                        <div class="location-info-grid">
                                            <div class="location-info-item">
                                                <div class="info-icon">
                                                    <i class="bi bi-geo-alt"></i>
                                                </div>
                                                <div class="info-content">
                                                    <label class="info-label">Address</label>
                                                    <div class="info-value">@Model.Location.Address</div>
                                                </div>
                                            </div>
                                            
                                            <div class="location-info-item">
                                                <div class="info-icon">
                                                    <i class="bi bi-pin-map"></i>
                                                </div>
                                                <div class="info-content">
                                                    <label class="info-label">Coordinates</label>
                                                    <div class="info-value coordinates-display">
                                                        @Model.Location.Latitude, @Model.Location.Longitude
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="location-actions mt-4">
                                            <div class="d-flex gap-2 flex-wrap">
                                                <a href="https://maps.google.com/?q=@Model.Location.Latitude,@Model.Location.Longitude" 
                                                   target="_blank" 
                                                   class="btn btn-primary btn-sm">
                                                    <i class="bi bi-map me-1"></i>Open in Google Maps
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-outline-secondary btn-sm" 
                                                        onclick="copyToClipboard('@Model.Location.Address')"
                                                        title="Copy address to clipboard">
                                                    <i class="bi bi-clipboard me-1"></i>Copy Address
                                                </button>
                                                <button type="button" 
                                                        class="btn btn-outline-info btn-sm" 
                                                        onclick="copyToClipboard('@Model.Location.Latitude, @Model.Location.Longitude')"
                                                        title="Copy coordinates to clipboard">
                                                    <i class="bi bi-geo-alt me-1"></i>Copy Coordinates
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interactive Map -->
                                <div class="col-lg-6 p-5">
                                    <div class="map-container">
                                        <div class="map-header">
                                            <h6 class="map-title">
                                                <i class="bi bi-map me-2"></i>Interactive Location Map
                                            </h6>
                                            <p class="map-description">Real-time map showing the installation site</p>
                                        </div>
                                        <div id="locationDetailsMap" 
                                             data-latitude="@Model.Location.Latitude" 
                                             data-longitude="@Model.Location.Longitude"
                                             data-name="@Model.Location.Name"
                                             data-address="@Model.Location.Address"
                                             data-description="@Model.Location.Description"
                                             class="location-map">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-geo-alt text-muted icon-large"></i>
                            <h6 class="text-muted mt-3">No Location Information</h6>
                            <p class="text-muted mb-0">Location details are not available for this order</p>
                        </div>
                    </div>
                }

                <!-- Action Buttons -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <a asp-action="List" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Back to Orders List
                            </a>
                            <div class="action-buttons">
                                @if (isAdminOrManager)
                                {
                                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary me-2">
                                        <i class="bi bi-pencil me-2"></i>Edit Order
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
                                        <i class="bi bi-trash me-2"></i>Delete Order
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Installed Devices -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Installed Devices</h5>
                    @if (isAdminOrManager)
                    {
                        <a asp-controller="InstalledDevice" asp-action="AddToOrder" asp-route-orderId="@Model.Id" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg me-2"></i>Add Device
                        </a>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.InstalledDevices != null && Model.InstalledDevices.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Device Type</th>
                                        <th>Brand</th>
                                        <th>Model</th>
                                        <th>Quantity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var device in Model.InstalledDevices)
                                    {
                                        <tr>
                                            <td>@device.DeviceType</td>
                                            <td>@device.Brand</td>
                                            <td>@device.Model</td>
                                            <td>@device.Quantity</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a asp-controller="InstalledDevice" asp-action="Details" asp-route-id="@device.Id" class="btn btn-sm btn-info">
                                                        <i class="bi bi-info-circle"></i>
                                                    </a>
                                                    @if (isAdminOrManager)
                                                    {
                                                        <a asp-controller="InstalledDevice" asp-action="Edit" asp-route-id="@device.Id" class="btn btn-sm btn-primary">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                    }
                                                    @if (isAdminOrManager)
                                                    {
                                                        <a asp-controller="InstalledDevice" asp-action="Delete" asp-route-id="@device.Id" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </a>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-device-hdd text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-0">No devices have been installed yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Maintenance Logs -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Maintenance Logs</h5>
                    @if (canManageMaintenance)
                    {
                        <a asp-controller="MaintenanceLog" asp-action="CreateForOrder" asp-route-orderId="@Model.Id" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg me-2"></i>Add Log
                        </a>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.MaintenanceLogs != null && Model.MaintenanceLogs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Technician</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in Model.MaintenanceLogs)
                                    {
                                        <tr>
                                            <td>@log.Date.ToString()</td>
                                            <td>@log.TechnicianFullName</td>
                                            <td>@(log.Description?.Length > 50 ? log.Description.Substring(0, 50) + "..." : log.Description)</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a asp-controller="MaintenanceLog" asp-action="Details" asp-route-id="@log.Id" class="btn btn-sm btn-info">
                                                        <i class="bi bi-info-circle"></i>
                                                    </a>
                                                    @if (canManageMaintenance)
                                                    {
                                                        <a asp-controller="MaintenanceLog" asp-action="Edit" asp-route-id="@log.Id" class="btn btn-sm btn-primary">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                    }
                                                    @if (canManageMaintenance)
                                                    {
                                                        <a asp-controller="MaintenanceLog" asp-action="Delete" asp-route-id="@log.Id" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </a>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-journal-text text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-0">No maintenance logs have been added yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Invoice Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Invoice Information</h5>
                </div>
                <div class="card-body">
                    @if (Model.Invoice != null)
                    {
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0">
                                <i class="bi bi-receipt me-2"></i>Invoice Details
                            </h6>
                        </div>
                        
                        <dl class="row">
                            <dt class="col-sm-5">Invoice ID</dt>
                            <dd class="col-sm-7">#@Model.Invoice.Id</dd>
                            
                            <dt class="col-sm-5">Issue Date</dt>
                            <dd class="col-sm-7">@Model.Invoice.IssuedOn.ToString("dd/MM/yyyy HH:mm")</dd>
                            
                            <dt class="col-sm-5">Amount</dt>
                            <dd class="col-sm-7">
                                <span class="fw-bold fs-5 text-success">$@Model.Invoice.TotalAmount.ToString("F2")</span>
                            </dd>
                            
                            <dt class="col-sm-5">Status</dt>
                            <dd class="col-sm-7">
                                <span class="badge bg-@(Model.Invoice.IsPaid ? "success" : "warning") fs-6">
                                    <i class="bi bi-@(Model.Invoice.IsPaid ? "check-circle" : "clock") me-1"></i>
                                    @(Model.Invoice.IsPaid ? "Paid" : "Unpaid")
                                </span>
                            </dd>
                            
                            @if (Model.Invoice.UpdatedAt != Model.Invoice.CreatedAt)
                            {
                                <dt class="col-sm-5">Last Updated</dt>
                                <dd class="col-sm-7">@Model.Invoice.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</dd>
                            }
                        </dl>
                        
                        <div class="d-grid gap-2 mt-3">
                            <a asp-controller="Invoice" asp-action="Details" asp-route-id="@Model.Invoice.Id" class="btn btn-outline-primary">
                                <i class="bi bi-file-earmark-pdf me-2"></i>View Invoice
                            </a>
                            @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                            {
                                @if (!Model.Invoice.IsPaid)
                                {
                                    <form asp-controller="Invoice" asp-action="MarkAsPaid" method="post" class="d-grid">
                                        <input type="hidden" name="id" value="@Model.Invoice.Id" />
                                        <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to mark this invoice as paid?');">
                                            <i class="bi bi-credit-card me-2"></i>Mark as Paid
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <form asp-controller="Invoice" asp-action="MarkAsUnpaid" method="post" class="d-grid">
                                        <input type="hidden" name="id" value="@Model.Invoice.Id" />
                                        <button type="submit" class="btn btn-warning" onclick="return confirm('Are you sure you want to mark this invoice as unpaid?');">
                                            <i class="bi bi-arrow-counterclockwise me-2"></i>Mark as Unpaid
                                        </button>
                                    </form>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-receipt text-muted icon-large"></i>
                            </div>
                            <h6 class="text-muted mb-2">No Invoice Generated</h6>
                            <p class="text-muted mb-3 small">An invoice will be created when you generate one for this order.</p>
                            @if (isAdminOrManager)
                            {
                                <button type="button" class="btn btn-primary" id="openInvoiceModal">
                                    <i class="bi bi-plus-lg me-2"></i>Generate Invoice
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
            
            <!-- Technicians -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Assigned Technicians</h5>
                    @if (ViewBag.CanManageTechnicians == true)
                    {
                        <button type="button" class="btn btn-sm btn-primary" id="openCustomModal">
                            <i class="bi bi-plus-lg me-2"></i>Assign
                        </button>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.Technicians != null && Model.Technicians.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var tech in Model.Technicians)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="technician-avatar me-3">
                                            @if (!string.IsNullOrEmpty(tech.ProfileImage))
                                            {
                                                <img src="@tech.ProfileImage" alt="@tech.FirstName @tech.LastName" class="rounded-circle" width="40" height="40">
                                            }
                                            else
                                            {
                                                <div class="rounded-circle text-white d-flex align-items-center justify-content-center tech-initials">
                                                    @(tech.FirstName?.Substring(0, 1))@(tech.LastName?.Substring(0, 1))
                                                </div>
                                            }
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@tech.FirstName @tech.LastName</h6>
                                            <small class="text-muted">@tech.Email</small>
                                        </div>
                                    </div>
                                    @if (ViewBag.CanManageTechnicians == true)
                                    {
                                        <form asp-action="RemoveTechnician" method="post" onsubmit="return confirm('Are you sure you want to remove this technician from the order?');">
                                            <input type="hidden" name="orderId" value="@Model.Id" />
                                            <input type="hidden" name="technicianId" value="@tech.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </form>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-people text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-0">No technicians assigned yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Assign Technician Modal -->
            @if (ViewBag.CanManageTechnicians == true)
            {
                <div id="customModal" class="custom-modal">
                    <div class="custom-modal-overlay" id="customModalOverlay"></div>
                    <div class="custom-modal-container">
                        <div class="custom-modal-content">
                            <div class="custom-modal-header bg-primary text-white py-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-person-plus-fill me-2"></i>Assign Technician
                                </h5>
                                <button type="button" class="btn-close btn-close-white" id="closeCustomModal"></button>
                            </div>
                            <form asp-action="AddTechnician" method="post">
                                <div class="custom-modal-body p-4">
                                    <input type="hidden" name="orderId" value="@Model.Id" />
                                    <div class="mb-4">
                                        <div class="form-group">
                                            <label for="technicianId" class="form-label text-dark fw-bold mb-2">
                                                <i class="bi bi-tools me-1"></i>Select Technician
                                            </label>
                                            @{
                                                var availableTechnicians = ViewBag.AvailableTechnicians as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>;
                                            }
                                            @if (availableTechnicians != null && availableTechnicians.Any())
                                            {
                                                <select name="technicianId" id="technicianId" class="form-select form-select-lg border-1 border-primary shadow-sm" required>
                                                    <option value="" disabled selected>-- Select Technician --</option>
                                                    @foreach (var tech in availableTechnicians)
                                                    {
                                                        <option value="@tech.Value">@tech.Text</option>
                                                    }
                                                </select>
                                                <div class="form-text mt-2">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Select a technician to assign to this order
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-info d-flex align-items-center">
                                                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                                    <div>
                                                        No available technicians found. All technicians are already assigned to this order or there are no technicians in the system.
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="custom-modal-footer bg-light py-3">
                                    <button type="button" class="btn btn-outline-secondary" id="cancelCustomModal">
                                        <i class="bi bi-x-lg me-2"></i>Cancel
                                    </button>
                                    @if (availableTechnicians != null && availableTechnicians.Any())
                                    {
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-lg me-2"></i>Assign
                                        </button>
                                    }
                                    else
                                    {
                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a asp-controller="User" asp-action="Create" class="btn btn-success">
                                                <i class="bi bi-plus-lg me-2"></i>Create Technician
                                            </a>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info d-flex align-items-center">
                                                <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                                <div>
                                                    Contact an administrator to create a new technician account.
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Generate Invoice Modal -->
            @if (isAdminOrManager)
            {
                <div id="invoiceModal" class="custom-modal">
                    <div class="custom-modal-overlay" id="invoiceModalOverlay"></div>
                    <div class="custom-modal-container">
                        <div class="custom-modal-content">
                            <div class="custom-modal-header bg-success text-white py-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-receipt me-2"></i>Generate Invoice
                                </h5>
                                <button type="button" class="btn-close btn-close-white" id="closeInvoiceModal"></button>
                            </div>
                            <form asp-action="GenerateInvoice" method="post" id="generateInvoiceForm">
                                <div class="custom-modal-body p-4">
                                    <input type="hidden" name="orderId" value="@Model.Id" />
                                    <div class="mb-4">
                                        <div class="form-group">
                                            <label for="laborCost" class="form-label text-dark fw-bold mb-2">
                                                <i class="bi bi-currency-dollar me-1"></i>Labor Cost
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" 
                                                       name="laborCost" 
                                                       id="laborCost" 
                                                       class="form-control form-control-lg border-1 border-success shadow-sm" 
                                                       step="0.01" 
                                                       min="0" 
                                                       required 
                                                       placeholder="0.00">
                                            </div>
                                            <div class="form-text mt-2">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Enter the total labor cost for this order
                                            </div>
                                        </div>
                                    </div>
                                    
                                    @if (Model.InstalledDevices != null && Model.InstalledDevices.Any())
                                    {
                                        <div class="mb-4">
                                            <h6 class="text-dark fw-bold mb-3">
                                                <i class="bi bi-device-hdd me-1"></i>Device Costs
                                            </h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Device</th>
                                                            <th>Quantity</th>
                                                            <th>Unit Price</th>
                                                            <th>Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var device in Model.InstalledDevices)
                                                        {
                                                            <tr>
                                                                <td>@device.Brand @device.Model</td>
                                                                <td>@device.Quantity</td>
                                                                <td>
                                                                    <input type="number" 
                                                                           name="deviceCosts[@device.Id]" 
                                                                           class="form-control form-control-sm device-cost" 
                                                                           step="0.01" 
                                                                           min="0" 
                                                                           placeholder="0.00">
                                                                </td>
                                                                <td class="device-total">$0.00</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    }
                                    
                                    <div class="alert alert-info">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold">Total Amount:</span>
                                            <span class="fw-bold fs-5" id="totalAmount">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="custom-modal-footer bg-light py-3">
                                    <button type="button" class="btn btn-outline-secondary" id="cancelInvoiceModal">
                                        <i class="bi bi-x-lg me-2"></i>Cancel
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-lg me-2"></i>Generate Invoice
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Activity Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Activity Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">Order Created</h6>
                                    <small class="text-muted">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                <p class="text-muted small mb-0">Order was created by @Model.Client?.FirstName @Model.Client?.LastName</p>
                            </div>
                        </div>
                        
                        @if (Model.Status >= OrderStatus.InProgress)
                        {
                                                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                                                    <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">Order In Progress</h6>
                                    <small class="text-muted">@Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                    <p class="text-muted small mb-0">Technicians started working on the order</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Status == OrderStatus.Completed)
                        {
                                                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                                                    <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">Order Completed</h6>
                                    <small class="text-muted">@Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                    <p class="text-muted small mb-0">All work has been completed</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Status == OrderStatus.Cancelled)
                        {
                                                            <div class="timeline-item">
                                <div class="timeline-marker bg-danger"></div>
                                <div class="timeline-content">
                                                                    <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">Order Cancelled</h6>
                                    <small class="text-muted">@Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                    <p class="text-muted small mb-0">The order was cancelled</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Invoice != null)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Invoice Generated</h6>
                                        <small class="text-muted">@Model.Invoice.IssuedOn.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <p class="text-muted small mb-0">Invoice #@Model.Invoice.Id was generated for $@Model.Invoice.TotalAmount.ToString("F2")</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="~/js/locations.js"></script>
    <script src="~/js/locations-details.js"></script>
    <script src="~/js/order-details-modal.js" asp-append-version="true"></script>
    <script src="~/js/invoice-modal.js" asp-append-version="true"></script>
}

@functions {
    string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "warning",
            OrderStatus.InProgress => "primary",
            OrderStatus.Completed => "success",
            OrderStatus.Cancelled => "danger",
            _ => "secondary"
        };
    }
    
    string GetStatusDisplayName(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.InProgress => "In Progress",
            _ => status.ToString()
        };
    }
}
