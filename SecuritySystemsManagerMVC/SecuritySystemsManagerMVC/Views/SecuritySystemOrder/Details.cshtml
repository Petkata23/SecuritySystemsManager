@model SecuritySystemsManagerMVC.ViewModels.SecuritySystemOrderDetailsVm
@using SecuritySystemsManager.Shared.Enums

@{
    ViewData["Title"] = "Order Details";
}

<div class="container-fluid animate-fade-in px-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">@Model.Title</h1>
                            <p class="mb-0">Order #@Model.Id</p>
                        </div>
                        <div>
                            <span class="badge bg-@GetStatusBadgeClass(Model.Status) fs-6 p-2">
                                @GetStatusDisplayName(Model.Status)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Order Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">General Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Title</dt>
                                <dd class="col-sm-8">@Model.Title</dd>
                                
                                <dt class="col-sm-4">Description</dt>
                                <dd class="col-sm-8">@Model.Description</dd>
                                
                                <dt class="col-sm-4">Phone</dt>
                                <dd class="col-sm-8">@Model.PhoneNumber</dd>
                                
                                <dt class="col-sm-4">Status</dt>
                                <dd class="col-sm-8">
                                    <span class="badge bg-@GetStatusBadgeClass(Model.Status)">
                                        @GetStatusDisplayName(Model.Status)
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-4">Requested Date</dt>
                                <dd class="col-sm-8">@Model.RequestedDate.ToString()</dd>
                            </dl>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Client Information</h6>
                            @if (Model.Client != null)
                            {
                                <div class="d-flex align-items-center mb-3">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                                        <i class="bi bi-person fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">@Model.Client.FirstName @Model.Client.LastName</h6>
                                        <p class="text-muted mb-0">@Model.Client.Email</p>
                                    </div>
                                </div>
                                
                                <dl class="row">
                                    <dt class="col-sm-4">Username</dt>
                                    <dd class="col-sm-8">@Model.Client.Username</dd>
                                    
                                    <dt class="col-sm-4">Role</dt>
                                    <dd class="col-sm-8">@Model.Client.RoleName</dd>
                                </dl>
                            }
                            else
                            {
                                <p class="text-muted">No client information available</p>
                            }
                        </div>
                    </div>
                    
                    <h6 class="text-muted mb-3">Location Information</h6>
                    @if (Model.Location != null)
                    {
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">Name</dt>
                                    <dd class="col-sm-8">@Model.Location.Name</dd>
                                    
                                    <dt class="col-sm-4">Address</dt>
                                    <dd class="col-sm-8">@Model.Location.Address</dd>
                                    
                                    <dt class="col-sm-4">Description</dt>
                                    <dd class="col-sm-8">@Model.Location.Description</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <div id="map" style="height: 200px; border-radius: 8px;"></div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No location information available</p>
                    }
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a asp-action="List" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                        <div>
                            <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger me-2">
                                <i class="bi bi-trash me-2"></i>Delete
                            </a>
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                                <i class="bi bi-pencil me-2"></i>Edit
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Installed Devices -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Installed Devices</h5>
                    <button class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-lg me-2"></i>Add Device
                    </button>
                </div>
                <div class="card-body p-0">
                    @if (Model.InstalledDevices != null && Model.InstalledDevices.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Device Type</th>
                                        <th>Brand</th>
                                        <th>Model</th>
                                        <th>Quantity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var device in Model.InstalledDevices)
                                    {
                                        <tr>
                                            <td>@device.DeviceType</td>
                                            <td>@device.Brand</td>
                                            <td>@device.Model</td>
                                            <td>@device.Quantity</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a href="#" class="btn btn-sm btn-info">
                                                        <i class="bi bi-info-circle"></i>
                                                    </a>
                                                    <a href="#" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <a href="#" class="btn btn-sm btn-danger">
                                                        <i class="bi bi-trash"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-device-hdd text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                            <p class="text-muted mb-0">No devices have been installed yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Maintenance Logs -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Maintenance Logs</h5>
                    <button class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-lg me-2"></i>Add Log
                    </button>
                </div>
                <div class="card-body p-0">
                    @if (Model.MaintenanceLogs != null && Model.MaintenanceLogs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Technician</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in Model.MaintenanceLogs)
                                    {
                                        <tr>
                                            <td>@log.Date.ToString()</td>
                                            <td>@log.TechnicianFullName</td>
                                            <td>@(log.Description?.Length > 50 ? log.Description.Substring(0, 50) + "..." : log.Description)</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a href="#" class="btn btn-sm btn-info">
                                                        <i class="bi bi-info-circle"></i>
                                                    </a>
                                                    <a href="#" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <a href="#" class="btn btn-sm btn-danger">
                                                        <i class="bi bi-trash"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-journal-text text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                            <p class="text-muted mb-0">No maintenance logs have been added yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Invoice Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Invoice Information</h5>
                </div>
                <div class="card-body">
                    @if (Model.Invoice != null)
                    {
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0">Invoice #@Model.Invoice.Id</h6>
                            <span class="badge bg-@(Model.Invoice.IsPaid ? "success" : "warning")">
                                @(Model.Invoice.IsPaid ? "Paid" : "Unpaid")
                            </span>
                        </div>
                        
                        <dl class="row">
                            <dt class="col-sm-5">Issue Date</dt>
                            <dd class="col-sm-7">@Model.Invoice.IssuedOn.ToString()</dd>
                            
                            <dt class="col-sm-5">Amount</dt>
                            <dd class="col-sm-7">$@Model.Invoice.TotalAmount.ToString()</dd>
                        </dl>
                        
                        <div class="d-grid gap-2 mt-3">
                            <a href="#" class="btn btn-outline-primary">
                                <i class="bi bi-file-earmark-pdf me-2"></i>View Invoice
                            </a>
                            @if (!Model.Invoice.IsPaid)
                            {
                                <a href="#" class="btn btn-success">
                                    <i class="bi bi-credit-card me-2"></i>Mark as Paid
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-receipt text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                            <p class="text-muted mb-3">No invoice has been generated yet</p>
                            <button class="btn btn-primary">
                                <i class="bi bi-plus-lg me-2"></i>Generate Invoice
                            </button>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Technicians -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Assigned Technicians</h5>
                    @if (ViewBag.CanManageTechnicians == true)
                    {
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignTechnicianModal">
                            <i class="bi bi-plus-lg me-2"></i>Assign
                        </button>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.Technicians != null && Model.Technicians.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var tech in Model.Technicians)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-person"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@tech.FirstName @tech.LastName</h6>
                                            <small class="text-muted">@tech.Email</small>
                                        </div>
                                    </div>
                                    @if (ViewBag.CanManageTechnicians == true)
                                    {
                                        <form asp-action="RemoveTechnician" method="post" onsubmit="return confirm('Are you sure you want to remove this technician from the order?');">
                                            <input type="hidden" name="orderId" value="@Model.Id" />
                                            <input type="hidden" name="technicianId" value="@tech.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </form>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-people text-muted" style="font-size: 2.5rem;"></i>
                            </div>
                            <p class="text-muted mb-0">No technicians assigned yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Assign Technician Modal -->
            @if (ViewBag.CanManageTechnicians == true)
            {
                <div class="modal fade" id="assignTechnicianModal" tabindex="-1" aria-labelledby="assignTechnicianModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="assignTechnicianModalLabel">Assign Technician</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form asp-action="AddTechnician" method="post">
                                <div class="modal-body">
                                    <input type="hidden" name="orderId" value="@Model.Id" />
                                    <div class="mb-3">
                                        <label for="technicianId" class="form-label">Select Technician</label>
                                        @if (ViewBag.AvailableTechnicians != null && ViewBag.AvailableTechnicians.Count > 0)
                                        {
                                            <select name="technicianId" id="technicianId" class="form-select" required>
                                                <option value="">-- Select Technician --</option>
                                                @foreach (var tech in ViewBag.AvailableTechnicians)
                                                {
                                                    <option value="@tech.Id">@tech.FirstName @tech.LastName (@tech.Email)</option>
                                                }
                                            </select>
                                        }
                                        else
                                        {
                                            <div class="alert alert-info">
                                                No available technicians found. All technicians are already assigned to this order or there are no technicians in the system.
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    @if (ViewBag.AvailableTechnicians != null && ViewBag.AvailableTechnicians.Count > 0)
                                    {
                                        <button type="submit" class="btn btn-primary">Assign</button>
                                    }
                                    else
                                    {
                                        <a asp-controller="User" asp-action="Create" class="btn btn-primary">Create Technician</a>
                                    }
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Activity Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Activity Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">Order Created</h6>
                                    <small class="text-muted">@Model.CreatedAt.ToString()</small>
                                </div>
                                <p class="text-muted small mb-0">Order was created by @Model.Client?.FirstName @Model.Client?.LastName</p>
                            </div>
                        </div>
                        
                        @if (Model.Status >= OrderStatus.InProgress)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Order In Progress</h6>
                                        <small class="text-muted">@Model.UpdatedAt.ToString()</small>
                                    </div>
                                    <p class="text-muted small mb-0">Technicians started working on the order</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Status == OrderStatus.Completed)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Order Completed</h6>
                                        <small class="text-muted">@Model.UpdatedAt.ToString()</small>
                                    </div>
                                    <p class="text-muted small mb-0">All work has been completed</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Status == OrderStatus.Cancelled)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-danger"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Order Cancelled</h6>
                                        <small class="text-muted">@Model.UpdatedAt.ToString()</small>
                                    </div>
                                    <p class="text-muted small mb-0">The order was cancelled</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize map if location exists
            @if (Model.Location != null)
            {
                <text>
                function initMap() {
                    const location = { 
                        lat: @Model.Location.Latitude, 
                        lng: @Model.Location.Longitude 
                    };
                    
                    const map = new google.maps.Map(document.getElementById("map"), {
                        zoom: 15,
                        center: location,
                        styles: [
                            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                            {
                                featureType: "administrative.locality",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#d59563" }],
                            },
                            {
                                featureType: "poi",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#d59563" }],
                            },
                            {
                                featureType: "poi.park",
                                elementType: "geometry",
                                stylers: [{ color: "#263c3f" }],
                            },
                            {
                                featureType: "poi.park",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#6b9a76" }],
                            },
                            {
                                featureType: "road",
                                elementType: "geometry",
                                stylers: [{ color: "#38414e" }],
                            },
                            {
                                featureType: "road",
                                elementType: "geometry.stroke",
                                stylers: [{ color: "#212a37" }],
                            },
                            {
                                featureType: "road",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#9ca5b3" }],
                            },
                            {
                                featureType: "road.highway",
                                elementType: "geometry",
                                stylers: [{ color: "#746855" }],
                            },
                            {
                                featureType: "road.highway",
                                elementType: "geometry.stroke",
                                stylers: [{ color: "#1f2835" }],
                            },
                            {
                                featureType: "road.highway",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#f3d19c" }],
                            },
                            {
                                featureType: "transit",
                                elementType: "geometry",
                                stylers: [{ color: "#2f3948" }],
                            },
                            {
                                featureType: "transit.station",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#d59563" }],
                            },
                            {
                                featureType: "water",
                                elementType: "geometry",
                                stylers: [{ color: "#17263c" }],
                            },
                            {
                                featureType: "water",
                                elementType: "labels.text.fill",
                                stylers: [{ color: "#515c6d" }],
                            },
                            {
                                featureType: "water",
                                elementType: "labels.text.stroke",
                                stylers: [{ color: "#17263c" }],
                            },
                        ]
                    });
                    
                    const marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: "@Model.Location.Name"
                    });
                }
                
                // Load Google Maps API
                $.getScript("https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap");
                window.initMap = initMap;
                </text>
            }
        });
    </script>
    
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline:before {
            content: '';
            position: absolute;
            top: 0;
            left: 15px;
            height: 100%;
            width: 2px;
            background: var(--bs-border-color);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 25px;
        }
        
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        
        .timeline-marker {
            position: absolute;
            left: -30px;
            top: 0;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            z-index: 1;
        }
    </style>
}

@functions {
    string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "warning",
            OrderStatus.InProgress => "primary",
            OrderStatus.Completed => "success",
            OrderStatus.Cancelled => "danger",
            _ => "secondary"
        };
    }
    
    string GetStatusDisplayName(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.InProgress => "In Progress",
            _ => status.ToString()
        };
    }
}
