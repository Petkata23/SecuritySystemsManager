@model SecuritySystemsManagerMVC.ViewModels.SecuritySystemOrderDetailsVm
@using SecuritySystemsManager.Shared.Enums

@{
    ViewData["Title"] = "Order Details";
    bool isClient = User.IsInRole("Client");
    bool isAdminOrManager = User.IsInRole("Admin") || User.IsInRole("Manager");
    bool isTechnician = User.IsInRole("Technician");
    bool canManageMaintenance = User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("Technician");
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="~/css/orders.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/order-details.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom-modal.css" asp-append-version="true" />
}

<div class="container-fluid animate-fade-in px-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2">@Model.Title</h1>
                            <p class="mb-0">Order #@Model.Id</p>
                        </div>
                        <div>
                            <span class="badge bg-@GetStatusBadgeClass(Model.Status) fs-6 p-2">
                                @GetStatusDisplayName(Model.Status)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Order Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">General Information</h6>
                            <dl class="row">
                                <dt class="col-sm-4">Title</dt>
                                <dd class="col-sm-8">@Model.Title</dd>
                                
                                <dt class="col-sm-4">Description</dt>
                                <dd class="col-sm-8">@Model.Description</dd>
                                
                                <dt class="col-sm-4">Phone</dt>
                                <dd class="col-sm-8">@Model.PhoneNumber</dd>
                                
                                <dt class="col-sm-4">Status</dt>
                                <dd class="col-sm-8">
                                    <span class="badge bg-@GetStatusBadgeClass(Model.Status)">
                                        @GetStatusDisplayName(Model.Status)
                                    </span>
                                </dd>
                                
                                <dt class="col-sm-4">Requested Date</dt>
                                <dd class="col-sm-8">@Model.RequestedDate.ToString()</dd>
                            </dl>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Client Information</h6>
                            @if (Model.Client != null)
                            {
                                <div class="d-flex align-items-center mb-3">
                                    <div class="client-avatar me-3">
                                        @if (!string.IsNullOrEmpty(Model.Client.ProfileImage))
                                        {
                                            <img src="@Model.Client.ProfileImage" alt="@Model.Client.FirstName @Model.Client.LastName" class="rounded-circle" width="48" height="48">
                                        }
                                        else
                                        {
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center client-initials">
                                                @(Model.Client.FirstName?.Substring(0, 1))@(Model.Client.LastName?.Substring(0, 1))
                                            </div>
                                        }
                                    </div>
                                    <div>
                                        <h6 class="mb-0">@Model.Client.FirstName @Model.Client.LastName</h6>
                                        <p class="text-muted mb-0">@Model.Client.Email</p>
                                    </div>
                                </div>
                                
                                <dl class="row">
                                    <dt class="col-sm-4">Username</dt>
                                    <dd class="col-sm-8">@Model.Client.Username</dd>
                                    
                                    <dt class="col-sm-4">Role</dt>
                                    <dd class="col-sm-8">@Model.Client.RoleName</dd>
                                </dl>
                            }
                            else
                            {
                                <p class="text-muted">No client information available</p>
                            }
                        </div>
                    </div>
                    
                    <h6 class="text-muted mb-3">Location Information</h6>
                    @if (Model.Location != null)
                    {
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">Name</dt>
                                    <dd class="col-sm-8">@Model.Location.Name</dd>
                                    
                                    <dt class="col-sm-4">Address</dt>
                                    <dd class="col-sm-8">@Model.Location.Address</dd>
                                    
                                    <dt class="col-sm-4">Description</dt>
                                    <dd class="col-sm-8">@Model.Location.Description</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <div id="locationDetailsMap" 
                                     data-latitude="@Model.Location.Latitude" 
                                     data-longitude="@Model.Location.Longitude"
                                     data-name="@Model.Location.Name"
                                     data-address="@Model.Location.Address"
                                     data-description="@Model.Location.Description"
                                     class="location-map">
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No location information available</p>
                    }
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a asp-action="List" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                        <div>
                            @if (isAdminOrManager)
                            {
                                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger me-2">
                                    <i class="bi bi-trash me-2"></i>Delete
                                </a>
                            }
                            @if (isAdminOrManager)
                            {
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                                    <i class="bi bi-pencil me-2"></i>Edit
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Installed Devices -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Installed Devices</h5>
                    @if (isAdminOrManager)
                    {
                        <a asp-controller="InstalledDevice" asp-action="AddToOrder" asp-route-orderId="@Model.Id" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg me-2"></i>Add Device
                        </a>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.InstalledDevices != null && Model.InstalledDevices.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Device Type</th>
                                        <th>Brand</th>
                                        <th>Model</th>
                                        <th>Quantity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var device in Model.InstalledDevices)
                                    {
                                        <tr>
                                            <td>@device.DeviceType</td>
                                            <td>@device.Brand</td>
                                            <td>@device.Model</td>
                                            <td>@device.Quantity</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a asp-controller="InstalledDevice" asp-action="Details" asp-route-id="@device.Id" class="btn btn-sm btn-info">
                                                        <i class="bi bi-info-circle"></i>
                                                    </a>
                                                    @if (isAdminOrManager)
                                                    {
                                                        <a asp-controller="InstalledDevice" asp-action="Edit" asp-route-id="@device.Id" class="btn btn-sm btn-primary">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                    }
                                                    @if (isAdminOrManager)
                                                    {
                                                        <a asp-controller="InstalledDevice" asp-action="Delete" asp-route-id="@device.Id" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </a>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-device-hdd text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-0">No devices have been installed yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Maintenance Logs -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Maintenance Logs</h5>
                    @if (canManageMaintenance)
                    {
                        <a asp-controller="MaintenanceLog" asp-action="CreateForOrder" asp-route-orderId="@Model.Id" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg me-2"></i>Add Log
                        </a>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.MaintenanceLogs != null && Model.MaintenanceLogs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Technician</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in Model.MaintenanceLogs)
                                    {
                                        <tr>
                                            <td>@log.Date.ToString()</td>
                                            <td>@log.TechnicianFullName</td>
                                            <td>@(log.Description?.Length > 50 ? log.Description.Substring(0, 50) + "..." : log.Description)</td>
                                            <td>
                                                <div class="btn-group">
                                                    <a asp-controller="MaintenanceLog" asp-action="Details" asp-route-id="@log.Id" class="btn btn-sm btn-info">
                                                        <i class="bi bi-info-circle"></i>
                                                    </a>
                                                    @if (canManageMaintenance)
                                                    {
                                                        <a asp-controller="MaintenanceLog" asp-action="Edit" asp-route-id="@log.Id" class="btn btn-sm btn-primary">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                    }
                                                    @if (canManageMaintenance)
                                                    {
                                                        <a asp-controller="MaintenanceLog" asp-action="Delete" asp-route-id="@log.Id" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-trash"></i>
                                                        </a>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-journal-text text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-0">No maintenance logs have been added yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Invoice Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Invoice Information</h5>
                </div>
                <div class="card-body">
                    @if (Model.Invoice != null)
                    {
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0">Invoice #@Model.Invoice.Id</h6>
                            <span class="badge bg-@(Model.Invoice.IsPaid ? "success" : "warning")">
                                @(Model.Invoice.IsPaid ? "Paid" : "Unpaid")
                            </span>
                        </div>
                        
                        <dl class="row">
                            <dt class="col-sm-5">Issue Date</dt>
                            <dd class="col-sm-7">@Model.Invoice.IssuedOn.ToString()</dd>
                            
                            <dt class="col-sm-5">Amount</dt>
                            <dd class="col-sm-7">$@Model.Invoice.TotalAmount.ToString()</dd>
                        </dl>
                        
                        <div class="d-grid gap-2 mt-3">
                            <a href="#" class="btn btn-outline-primary">
                                <i class="bi bi-file-earmark-pdf me-2"></i>View Invoice
                            </a>
                            @if (!Model.Invoice.IsPaid)
                            {
                                <a href="#" class="btn btn-success">
                                    <i class="bi bi-credit-card me-2"></i>Mark as Paid
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-receipt text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-3">No invoice has been generated yet</p>
                            @if (isAdminOrManager)
                            {
                                <form asp-action="GenerateInvoice" method="post" style="display: inline;">
                                    <input type="hidden" name="orderId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-lg me-2"></i>Generate Invoice
                                    </button>
                                </form>
                            }
                        </div>
                    }
                </div>
            </div>
            
            <!-- Technicians -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Assigned Technicians</h5>
                    @if (ViewBag.CanManageTechnicians == true)
                    {
                        <button type="button" class="btn btn-sm btn-primary" id="openCustomModal">
                            <i class="bi bi-plus-lg me-2"></i>Assign
                        </button>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.Technicians != null && Model.Technicians.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var tech in Model.Technicians)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="technician-avatar me-3">
                                            @if (!string.IsNullOrEmpty(tech.ProfileImage))
                                            {
                                                <img src="@tech.ProfileImage" alt="@tech.FirstName @tech.LastName" class="rounded-circle" width="40" height="40">
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center tech-initials">
                                                    @(tech.FirstName?.Substring(0, 1))@(tech.LastName?.Substring(0, 1))
                                                </div>
                                            }
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@tech.FirstName @tech.LastName</h6>
                                            <small class="text-muted">@tech.Email</small>
                                        </div>
                                    </div>
                                    @if (ViewBag.CanManageTechnicians == true)
                                    {
                                        <form asp-action="RemoveTechnician" method="post" onsubmit="return confirm('Are you sure you want to remove this technician from the order?');">
                                            <input type="hidden" name="orderId" value="@Model.Id" />
                                            <input type="hidden" name="technicianId" value="@tech.Id" />
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </form>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-people text-muted icon-large"></i>
                            </div>
                            <p class="text-muted mb-0">No technicians assigned yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Assign Technician Modal -->
            @if (ViewBag.CanManageTechnicians == true)
            {
                <div id="customModal" class="custom-modal">
                    <div class="custom-modal-overlay" id="customModalOverlay"></div>
                    <div class="custom-modal-container">
                        <div class="custom-modal-content">
                            <div class="custom-modal-header bg-primary text-white py-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-person-plus-fill me-2"></i>Assign Technician
                                </h5>
                                <button type="button" class="btn-close btn-close-white" id="closeCustomModal"></button>
                            </div>
                            <form asp-action="AddTechnician" method="post">
                                <div class="custom-modal-body p-4">
                                    <input type="hidden" name="orderId" value="@Model.Id" />
                                    <div class="mb-4">
                                        <div class="form-group">
                                            <label for="technicianId" class="form-label text-dark fw-bold mb-2">
                                                <i class="bi bi-tools me-1"></i>Select Technician
                                            </label>
                                            @if (ViewBag.AvailableTechnicians != null && ViewBag.AvailableTechnicians.Count > 0)
                                            {
                                                <select name="technicianId" id="technicianId" class="form-select form-select-lg border-1 border-primary shadow-sm" required>
                                                    <option value="" disabled selected>-- Select Technician --</option>
                                                    @foreach (var tech in ViewBag.AvailableTechnicians)
                                                    {
                                                        <option value="@tech.Id">@tech.FirstName @tech.LastName</option>
                                                    }
                                                </select>
                                                <div class="form-text mt-2">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Select a technician to assign to this order
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-info d-flex align-items-center">
                                                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                                    <div>
                                                        No available technicians found. All technicians are already assigned to this order or there are no technicians in the system.
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="custom-modal-footer bg-light py-3">
                                    <button type="button" class="btn btn-outline-secondary" id="cancelCustomModal">
                                        <i class="bi bi-x-lg me-2"></i>Cancel
                                    </button>
                                    @if (ViewBag.AvailableTechnicians != null && ViewBag.AvailableTechnicians.Count > 0)
                                    {
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-lg me-2"></i>Assign
                                        </button>
                                    }
                                    else
                                    {
                                        <a asp-controller="User" asp-action="Create" class="btn btn-success">
                                            <i class="bi bi-plus-lg me-2"></i>Create Technician
                                        </a>
                                    }
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Activity Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">Activity Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">Order Created</h6>
                                    <small class="text-muted">@Model.CreatedAt.ToString()</small>
                                </div>
                                <p class="text-muted small mb-0">Order was created by @Model.Client?.FirstName @Model.Client?.LastName</p>
                            </div>
                        </div>
                        
                        @if (Model.Status >= OrderStatus.InProgress)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Order In Progress</h6>
                                        <small class="text-muted">@Model.UpdatedAt.ToString()</small>
                                    </div>
                                    <p class="text-muted small mb-0">Technicians started working on the order</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Status == OrderStatus.Completed)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Order Completed</h6>
                                        <small class="text-muted">@Model.UpdatedAt.ToString()</small>
                                    </div>
                                    <p class="text-muted small mb-0">All work has been completed</p>
                                </div>
                            </div>
                        }
                        
                        @if (Model.Status == OrderStatus.Cancelled)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-danger"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">Order Cancelled</h6>
                                        <small class="text-muted">@Model.UpdatedAt.ToString()</small>
                                    </div>
                                    <p class="text-muted small mb-0">The order was cancelled</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="~/js/locations.js"></script>
    <script src="~/js/locations-details.js"></script>
    <script>
        $(document).ready(function() {
            // Custom modal functionality
            var $customModal = $('#customModal');
            var $customModalOverlay = $('#customModalOverlay');
            var $openCustomModalBtn = $('#openCustomModal');
            var $closeCustomModalBtn = $('#closeCustomModal');
            var $cancelCustomModalBtn = $('#cancelCustomModal');
            
            // Open modal
            $openCustomModalBtn.on('click', function() {
                $customModal.addClass('show');
            });
            
            // Close modal
            function closeCustomModal() {
                $customModal.removeClass('show');
            }
            
            $closeCustomModalBtn.on('click', closeCustomModal);
            $cancelCustomModalBtn.on('click', closeCustomModal);
            $customModalOverlay.on('click', closeCustomModal);
            
            // Close modal on ESC key
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $customModal.hasClass('show')) {
                    closeCustomModal();
                }
            });
        });
    </script>
}

@functions {
    string GetStatusBadgeClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "warning",
            OrderStatus.InProgress => "primary",
            OrderStatus.Completed => "success",
            OrderStatus.Cancelled => "danger",
            _ => "secondary"
        };
    }
    
    string GetStatusDisplayName(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.InProgress => "In Progress",
            _ => status.ToString()
        };
    }
}
